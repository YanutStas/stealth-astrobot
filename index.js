require("dotenv").config();
const { Telegraf } = require("telegraf");
const axios = require("axios");

const bot = new Telegraf(process.env.BOT_TOKEN);

// âœ… ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ
bot.start((ctx) => {
  ctx.reply(
    `ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ â€” AstroBot ðŸŒŸ\n\nÐ§Ñ‚Ð¾Ð±Ñ‹ Ñ ÑÐ¾ÑÑ‚Ð°Ð²Ð¸Ð» Ñ‚Ð²Ð¾ÑŽ Ð½Ð°Ñ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ñƒ, Ð¿Ñ€Ð¸ÑˆÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ:\n\nðŸ“… Ð”Ð”.ÐœÐœ.Ð“Ð“Ð“Ð“ â° Ð§Ð§:ÐœÐœ ðŸ—ºï¸ Ð“Ð¾Ñ€Ð¾Ð´\n\nÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 01.01.2000 10:00 ÐœÐ¾ÑÐºÐ²Ð°`
  );
});

// âœ… ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
bot.on("text", async (ctx) => {
  const userInput = ctx.message.text.trim();

  // ðŸ‘‡ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: Ð´Ð°Ñ‚Ð°, Ð²Ñ€ÐµÐ¼Ñ Ð¸ Ð³Ð¾Ñ€Ð¾Ð´
  if (!/^\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}\s+.+$/.test(userInput)) {
    return ctx.reply(
      "â— ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. Ð’Ð²ÐµÐ´Ð¸ Ñ‚Ð°Ðº:\nÐ”Ð”.ÐœÐœ.Ð“Ð“Ð“Ð“ Ð§Ð§:ÐœÐœ Ð“Ð¾Ñ€Ð¾Ð´\n\nÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 01.01.2000 10:00 ÐœÐ¾ÑÐºÐ²Ð°"
    );
  }

  ctx.reply("ðŸ”­ Ð¡Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑŽ ÐºÐ°Ñ€Ñ‚Ñƒ Ð·Ð²Ñ‘Ð·Ð´...");

  const systemPrompt = `Ð¡Ð¾ÑÑ‚Ð°Ð²ÑŒ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ Ð½Ð°Ñ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ñƒ Ð´Ð»Ñ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°, Ñ€Ð¾Ð´Ð¸Ð²ÑˆÐµÐ³Ð¾ÑÑ ${userInput}. Ð£ÐºÐ°Ð¶Ð¸:

â˜€ï¸ Ð¡Ð¾Ð»Ð½Ñ†Ðµ â€” Ð·Ð½Ð°Ðº Ð¸ ÐµÐ³Ð¾ Ð²Ð»Ð¸ÑÐ½Ð¸Ðµ  
ðŸŒ™ Ð›ÑƒÐ½Ð° â€” Ð·Ð½Ð°Ðº Ð¸ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸  
ðŸ§  ÐœÐµÑ€ÐºÑƒÑ€Ð¸Ð¹ â€” ÑÑ‚Ð¸Ð»ÑŒ Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð¸Ñ  
ðŸ”¥ ÐœÐ°Ñ€Ñ â€” ÑÐ½ÐµÑ€Ð³Ð¸Ñ Ð¸ Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ

ÐÐµ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹ Ð»ÑŽÐ±Ð¾Ð²ÑŒ, ÑÐµÐºÑ, Ð´ÐµÐ½ÑŒÐ³Ð¸, Ñ„Ð¸Ð½Ð°Ð½ÑÑ‹, ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ, Ð²ÐµÐ½ÐµÑ€Ñƒ Ð¸ 12 Ð´Ð¾Ð¼. Ð“Ð¾Ð²Ð¾Ñ€Ð¸ Ñ‚ÐµÐ¿Ð»Ð¾, Ð¿Ð¾-Ð´Ñ€ÑƒÐ¶ÐµÑÐºÐ¸, Ð±ÐµÐ· ÑÐ·Ð¾Ñ‚ÐµÑ€Ð¸ÐºÐ¸. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ¸, Ð³Ð¾Ð²Ð¾Ñ€Ð¸ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ð¸ ÑÑƒÑ‚ÑŒ.

Ð’ ÐºÐ¾Ð½Ñ†Ðµ Ð´Ð¾Ð±Ð°Ð²ÑŒ Ð²Ñ‹Ð²Ð¾Ð´ Ð² Ñ‚Ð°ÐºÐ¾Ð¼ ÑÑ‚Ð¸Ð»Ðµ:
â€”
âœ¨ Ð’ Ð¸Ñ‚Ð¾Ð³Ðµ: ... (Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ð¸Ñ‚Ð¾Ð³ Ð¾ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐµ)
`;

  try {
    const response = await axios.post(
      "https://openrouter.ai/api/v1/chat/completions",
      {
        model: "openai/gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content:
              "Ð¢Ñ‹ Ð°ÑÑ‚Ñ€Ð¾Ð»Ð¾Ð³, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¸ÑˆÐµÑ‚ Ð¿Ð¾-Ñ‡ÐµÐ»Ð¾Ð²ÐµÑ‡ÐµÑÐºÐ¸. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑˆÑŒ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ¸, Ð¿Ð¸ÑˆÐ¸ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð² Ð·Ð°Ð´Ð°Ð½Ð½Ð¾Ð¼ ÑˆÐ°Ð±Ð»Ð¾Ð½Ðµ.",
          },
          { role: "user", content: systemPrompt },
        ],
      },
      {
        headers: {
          Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}`,
          "HTTP-Referer": `https://t.me/${process.env.BOT_USERNAME}`,
          "Content-Type": "application/json",
        },
      }
    );

    const output =
      response.data.choices?.[0]?.message?.content?.trim() ||
      "ðŸŒŒ Ð—Ð²Ñ‘Ð·Ð´Ñ‹ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð¼Ð¾Ð»Ñ‡Ð°Ñ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ.";

    ctx.reply(output);
  } catch (error) {
    console.error(
      "âŒ OpenRouter API Error:",
      error.response?.data || error.message
    );
    ctx.reply("ðŸ› ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¸ Ðº Ð·Ð²Ñ‘Ð·Ð´Ð°Ð¼. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð¿Ð¾Ð·Ð¶Ðµ.");
  }
});

bot.launch();

process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));
