// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ü–õ–ê–¢–ù–´–ï –ö–ù–û–ü–ö–ò / —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const axios = require("axios");
const { Markup } = require("telegraf");
const logger = require("../logger");

const cardInfo = "2202 2006 1234 5678";

const payMsg = (what) =>
  `üí≥ –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å *${what}*, –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ 10 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É:\n\n${cardInfo}\n\n` +
  "–ó–∞—Ç–µ–º –ø—Ä–∏—à–ª–∏—Ç–µ —Å—é–¥–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ —á–µ–∫ üëá";

module.exports = (bot) => {
  // –ö–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã
  bot.action("love_start", async (ctx) => {
    await ctx.answerCbQuery();
    ctx.reply(payMsg("—Ä–∞–∑–±–æ—Ä –ª—é–±–≤–∏"), { parse_mode: "Markdown" });
  });
  bot.action("career_start", async (ctx) => {
    await ctx.answerCbQuery();
    ctx.reply(payMsg("–∫–∞—Ä—å–µ—Ä–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑"), { parse_mode: "Markdown" });
  });
  bot.action("compat_start", async (ctx) => {
    await ctx.answerCbQuery();
    ctx.reply(payMsg("–∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏"), { parse_mode: "Markdown" });
  });

  // —á–µ–∫ ‚Üí –∞–¥–º–∏–Ω
  bot.on(["photo", "document"], async (ctx) => {
    await ctx.reply(
      "üì© –ß–µ–∫ –ø—Ä–∏–Ω—è—Ç! –û—Ç–∫—Ä–æ—é –¥–æ—Å—Ç—É–ø, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ê–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç."
    );
    await ctx.forwardMessage(process.env.ADMIN_ID);
    await bot.telegram.sendMessage(
      process.env.ADMIN_ID,
      `üßæ –ß–µ–∫ –æ—Ç @${ctx.from.username || "anon"} (ID: ${ctx.from.id})`,
      Markup.inlineKeyboard([
        [
          Markup.button.callback("‚úîÔ∏è –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", `grant_ok_${ctx.from.id}`),
          Markup.button.callback("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", `grant_no_${ctx.from.id}`),
        ],
      ])
    );
  });

  // ====== –ü–õ–ê–¢–ù–ê–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ ======
  const dualReg =
    /^\s*(\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}\s+.+?)\s*&\s*(\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}\s+.+)$/;
  bot.hears(dualReg, async (ctx) => {
    const [, p1, p2] = ctx.message.text.match(dualReg);
    const t0 = Date.now(),
      u = ctx.from.username || ctx.from.id;
    logger.info(`[compat-req] @${u}`);

    await ctx.reply("üíû –ü—Ä–æ–≤–µ—Ä—è—é —Ö–∏–º–∏—á–µ—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–π‚Ä¶");

    const prompt =
      `–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π (–¥–æ 1800 —Å–∏–º–≤.) –∞–Ω–∞–ª–∏–∑ *—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏* –ø–∞—Ä—ã:\n` +
      `‚Ä¢ –ü–∞—Ä—Ç–Ω—ë—Ä –ê: ${p1}\n‚Ä¢ –ü–∞—Ä—Ç–Ω—ë—Ä –ë: ${p2}\n\n` +
      "–í—ã–≤–µ–¥–∏ 5 –±–ª–æ–∫–æ–≤ –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ 3-—Ö —Å—Ç—Ä–æ–∫:\n" +
      "1. üåü –û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –ø–∞—Ä—ã\n" +
      "2. üíó –≠–º–æ—Ü–∏–∏ –∏ –±—ã—Ç\n" +
      "3. üî• –ò–Ω—Ç–∏–º / —Å—Ç—Ä–∞—Å—Ç—å\n" +
      "4. ü§ù –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ —Ä–æ—Å—Ç\n" +
      "5. ‚ú® –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –Ω–∞ –≥–æ–¥ –≤–ø–µ—Ä—ë–¥\n\n" +
      "–ó–∞–≤–µ—Ä—à–∏ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π-—Å–æ–≤–µ—Ç–æ–º.\n" +
      "–¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫, —ç–º–æ–¥–∑–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è, markdown –Ω–µ –Ω—É–∂–µ–Ω.";

    try {
      const { data } = await axios.post(
        "https://openrouter.ai/api/v1/chat/completions",
        {
          model: "openrouter/auto",
          messages: [{ role: "user", content: prompt }],
        },
        {
          headers: {
            Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}`,
            "Content-Type": "application/json",
          },
        }
      );
      await ctx.reply(
        data.choices?.[0]?.message?.content?.trim() ||
          "üåå –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ–∫–∞ –Ω–µ —è—Å–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
      );
      logger.info(`[compat-ok ] @${u} | ${Date.now() - t0} –º—Å`);
    } catch (e) {
      logger.error(`[compat-fail] ${e.message}`);
      ctx.reply("üõ†Ô∏è –ù–µ —Å–º–æ–≥ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.");
    }
  });
};

// // –ø–ª–∞—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ¬´–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å¬ª

// const { Markup } = require("telegraf");

// module.exports = (bot) => {
//   // –∫–Ω–æ–ø–∫–∞ ¬´–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–ø–ª–∞—Ç–Ω–æ)¬ª –∏–∑ –º–µ–Ω—é
//   bot.action("compat_start", async (ctx) => {
//     await ctx.answerCbQuery();
//     ctx.reply(
//       "üí≥ –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤—å 10 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É:\n\n" +
//         "2202 2006 1234 5678\n\n" +
//         "–ó–∞—Ç–µ–º –ø—Ä–∏—à–ª–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ —á–µ–∫ —Å—é–¥–∞ üëá"
//     );
//   });

//   // /compat ‚Äî –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–±—Ä–∞–ª –≤—Ä—É—á–Ω—É—é
//   bot.command("compat", (ctx) => {
//     ctx.reply(
//       "üí≥ –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤—å 10 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É:\n\n" +
//         "2202 2006 1234 5678\n\n" +
//         "–ó–∞—Ç–µ–º –ø—Ä–∏—à–ª–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ —á–µ–∫ —Å—é–¥–∞ üëá"
//     );
//   });

//   // –ø—Ä–∏—ë–º —á–µ–∫–æ–≤ (—Ñ–æ—Ç–æ/–¥–æ–∫)
//   bot.on(["photo", "document"], async (ctx) => {
//     const user = ctx.from;

//     // —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
//     await ctx.reply(
//       "üì© –ß–µ–∫ –ø–æ–ª—É—á–µ–Ω! –ü—Ä–æ–≤–µ—Ä—é –∏ –¥–∞–º –∑–Ω–∞—Ç—å, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –æ–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—Å—è."
//     );

//     // –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∞–¥–º–∏–Ω—É
//     const fwdMsg = await ctx.forwardMessage(process.env.ADMIN_ID);

//     // –ø–æ–¥ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º ‚Äî –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
//     await bot.telegram.sendMessage(
//       process.env.ADMIN_ID,
//       `üßæ –ß–µ–∫ –æ—Ç @${user.username || "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"} (ID: ${user.id})`,
//       Markup.inlineKeyboard([
//         Markup.button.callback("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ", `grant_ok_${user.id}`),
//         Markup.button.callback("‚ùå –ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ", `grant_no_${user.id}`),
//       ])
//     );
//   });
// };
