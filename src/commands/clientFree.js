// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ë–ï–°–ü–õ–ê–¢–ù–´–ï –§–ò–ß–ò  |  —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è, –Ω–æ —É—Ä–µ–∑–∞–Ω–Ω–∞—è –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const axios = require("axios");
const { DateTime } = require("luxon");
const { Markup } = require("telegraf");
const logger = require("../logger");

// ‚Äî‚Äî‚Äî –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
const natalReg = /^\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}\s+.+$/;
function isValidNatal(text) {
  if (!natalReg.test(text.trim())) return false;
  const [dateStr, timeStr] = text.split(/\s+/);
  return DateTime.fromFormat(`${dateStr} ${timeStr}`, "dd.MM.yyyy HH:mm")
    .isValid;
}

// ‚Äî‚Äî‚Äî –¶–µ–ø–æ—á–∫–∞ fallback-–º–æ–¥–µ–ª–µ–π
const MODEL_CHAIN = [
  "openrouter/auto",
  "mistralai/mistral-7b-instruct",
  "anthropic/claude-3-haiku-20240307",
];

// ‚Äî‚Äî‚Äî –≠–∫—Å–ø–æ—Ä—Ç
module.exports = (bot) => {
  // /start
  bot.start((ctx) => {
    ctx.reply(
      "–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ:",
      Markup.inlineKeyboard([
        [Markup.button.callback("üîÆ –û–±—â–∞—è (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)", "natal_start")],
        [Markup.button.callback("üíû –õ—é–±–æ–≤—å (–ø–ª–∞—Ç–Ω–æ)", "love_start")],
        [Markup.button.callback("üíº –ö–∞—Ä—å–µ—Ä–∞ (–ø–ª–∞—Ç–Ω–æ)", "career_start")],
        [Markup.button.callback("‚ù§Ô∏è –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–ø–ª–∞—Ç–Ω–æ)", "compat_start")],
      ])
    );
  });

  // ¬´–û–±—â–∞—è (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)¬ª
  bot.action("natal_start", async (ctx) => {
    await ctx.answerCbQuery();
    ctx.reply(
      "–ß—Ç–æ–±—ã —è —Å–æ—Å—Ç–∞–≤–∏–ª —Ç–≤–æ—é –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É, –ø—Ä–∏—à–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n\n" +
        "üìÖ *–î–î.–ú–ú.–ì–ì–ì–ì*   ‚è∞ *–ß–ß:–ú–ú*   üó∫ *–ì–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è*\n\n" +
        "_–ü—Ä–∏–º–µ—Ä_: 01.01.2000 10:00 –ú–æ—Å–∫–≤–∞",
      { parse_mode: "Markdown" }
    );
  });

  // ‚Äî‚Äî‚Äî —Ä–∞—Å—á—ë—Ç –Ω–∞—Ç–∞–ª–∫–∏
  bot.hears(isValidNatal, async (ctx) => {
    const t0 = Date.now();
    const { id, username } = ctx.from;
    logger.info(`üì• @${username || id}: ${ctx.message.text}`);
    await ctx.reply("üî≠ –°–æ—Å—Ç–∞–≤–ª—è—é –∫–∞—Ä—Ç—É –∑–≤—ë–∑–¥‚Ä¶");

    // –ø—Ä–æ–º–ø—Ç
    const userInput = ctx.message.text.trim();
    const prompt = `–°–æ—Å—Ç–∞–≤—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é, –Ω–æ –∫–æ—Ä–æ—Ç–∫—É—é (–¥–æ 1200 —Å–∏–º–≤.) –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, —Ä–æ–¥–∏–≤—à–µ–≥–æ—Å—è ${userInput}.  
–í—ã–≤–µ–¥–∏ –†–û–í–ù–û 7 –±–ª–æ–∫–æ–≤, –∫–∞–∂–¥—ã–π ‚â§ 3 —Å—Ç—Ä–æ–∫:

1. ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ ‚Äî –≥–ª–∞–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ª–∏—á–Ω–æ—Å—Ç–∏  
2. üåô –õ—É–Ω–∞ ‚Äî —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å  
3. ü°± –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç ‚Äî –ø–µ—Ä–≤–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ  
4. üí† –°–µ–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª ‚Äî –∫–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞  
5. üé® –¢–∞–ª–∞–Ω—Ç—ã –∏ —Ö–æ–±–±–∏ ‚Äî –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã  
6. üßò –ó–¥–æ—Ä–æ–≤—å–µ –∏ —Ä–µ—Å—É—Ä—Å ‚Äî –∫—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç  
7. üåÄ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç ‚Äî –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å  

‚õî –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞—Ç—å: –ª—é–±–æ–≤—å, –±—Ä–∞–∫, –ø–∞—Ä—Ç–Ω—ë—Ä–∞, —Å–µ–∫—Å, —Å–µ–º—å—é, –¥–µ—Ç–µ–π, –∫–∞—Ä—å–µ—Ä—É, –¥–µ–Ω—å–≥–∏, —Ñ–∏–Ω–∞–Ω—Å—ã, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å, –í–µ–Ω–µ—Ä—É –∏ XII –¥–æ–º.  
–ü–∏—à–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø–æ-—Ä—É—Å—Å–∫–∏, –±–µ–∑ —ç–∑–æ—Ç–µ—Ä–∏–∫–∏, —Å–æ —Å–º–∞–π–ª–∏–∫–∞–º–∏.

–í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å:  
‚Äî  
‚ú® *–í –∏—Ç–æ–≥–µ*: ‚Ä¶ (–æ–¥–Ω–∞ —Ñ—Ä–∞–∑–∞-–≤—ã–∂–∏–º–∫–∞)

–ü–æ—Å–ª–µ –∏—Ç–æ–≥–∞ –≤—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É:  
üíé *–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –æ –ª—é–±–≤–∏, –¥–µ–Ω—å–≥–∞—Ö –∏–ª–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏? –ù–∞–∂–º–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–ª–∞—Ç–Ω—É—é –∫–Ω–æ–ø–∫—É!*`;

    let success = false,
      lastErr;
    for (const model of MODEL_CHAIN) {
      try {
        const { data } = await axios.post(
          "https://openrouter.ai/api/v1/chat/completions",
          {
            model,
            messages: [
              {
                role: "system",
                content: "–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥, –ø–∏—à–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.",
              },
              { role: "user", content: prompt },
            ],
          },
          {
            headers: {
              Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}`,
              "HTTP-Referer": `https://t.me/${process.env.BOT_USERNAME}`,
              "Content-Type": "application/json",
            },
          }
        );

        await ctx.reply(
          data.choices?.[0]?.message?.content?.trim() ||
            "üåå –ó–≤—ë–∑–¥—ã –º–æ–ª—á–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ."
        );
        logger.info(`üì§ @${username || id}: ${model} | ${Date.now() - t0} –º—Å`);
        success = true;
        break;
      } catch (e) {
        lastErr = e;
        logger.warn(
          `‚ö†Ô∏è Switch model ${model} ‚Üí ${e.response?.status || e.message}`
        );
      }
    }
    if (!success) {
      logger.error(
        `‚ùå –í—Å–µ –º–æ–¥–µ–ª–∏ —É–ø–∞–ª–∏ –¥–ª—è @${username || id}: ${lastErr?.message}`
      );
      ctx.reply("üõ†Ô∏è –ó–≤—ë–∑–¥—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.");
    }
  });

  // –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
  bot.on("text", (ctx, next) => {
    if (!isValidNatal(ctx.message.text)) {
      return ctx.reply("ü§î –§–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π. –ù—É–∂–µ–Ω: *–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú –ì–æ—Ä–æ–¥*", {
        parse_mode: "Markdown",
      });
    }
    return next();
  });
};

// // –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞)

// const axios = require("axios");
// const { DateTime } = require("luxon");
// const { Markup } = require("telegraf");
// const logger = require("../logger");

// // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// const natalReg = /^\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}\s+.+$/;
// function isValidNatal(text) {
//   if (!natalReg.test(text.trim())) return false;
//   const [dateStr, timeStr] = text.split(/\s+/);
//   const dt = DateTime.fromFormat(`${dateStr} ${timeStr}`, "dd.MM.yyyy HH:mm");
//   return dt.isValid;
// }

// // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –¶–µ–ø–æ—á–∫–∞ –º–æ–¥–µ–ª–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// const MODEL_CHAIN = [
//   "openrouter/auto",
//   "mistralai/mistral-7b-instruct",
//   "anthropic/claude-3-haiku-20240307",
// ];

// // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// module.exports = (bot) => {
//   // /start ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫–Ω–æ–ø–∫–∏
//   bot.start((ctx) => {
//     ctx.reply(
//       "–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ:",
//       Markup.inlineKeyboard([
//         [Markup.button.callback("üîÆ –û–±—â–∞—è (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)", "natal_start")],
//         [Markup.button.callback("‚ù§Ô∏è –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–ø–ª–∞—Ç–Ω–æ)", "compat_start")],
//       ])
//     );
//   });

//   // –∫–Ω–æ–ø–∫–∞ ¬´–û–±—â–∞—è (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)¬ª
//   bot.action("natal_start", async (ctx) => {
//     await ctx.answerCbQuery();
//     ctx.reply(
//       "–ß—Ç–æ–±—ã —è —Å–æ—Å—Ç–∞–≤–∏–ª —Ç–≤–æ—é –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É, –ø—Ä–∏—à–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n\n" +
//         "üìÖ –î–î.–ú–ú.–ì–ì–ì–ì ‚è∞ –ß–ß:–ú–ú üó∫Ô∏è –ì–æ—Ä–æ–¥\n\n" +
//         "–ù–∞–ø—Ä.: 01.01.2000 10:00 –ú–æ—Å–∫–≤–∞"
//     );
//   });

//   // –Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞
//   bot.hears(isValidNatal, async (ctx) => {
//     const tsStart = Date.now();
//     const { id, username, first_name, last_name } = ctx.from;

//     logger.info(`üì• @${username || id}: ${ctx.message.text}`);

//     await ctx.reply("üî≠ –°–æ—Å—Ç–∞–≤–ª—è—é –∫–∞—Ä—Ç—É –∑–≤—ë–∑–¥...");

//     const userInput = ctx.message.text.trim();
//     const prompt = `**–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∏–∫–∞–∫–∏–µ —è–∑—ã–∫–∏, –∫—Ä–æ–º–µ —Ä—É—Åc–∫–æ–≥–æ.** –°–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫—É—é –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, —Ä–æ–¥–∏–≤—à–µ–≥–æ—Å—è ${userInput}. –£–∫–∞–∂–∏:

// ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ ‚Äî –∑–Ω–∞–∫ –∏ –≤–ª–∏—è–Ω–∏–µ
// üåô –õ—É–Ω–∞ ‚Äî –∑–Ω–∞–∫ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
// üß† –ú–µ—Ä–∫—É—Ä–∏–π ‚Äî —Å—Ç–∏–ª—å –º—ã—à–ª–µ–Ω–∏—è
// üî• –ú–∞—Ä—Å ‚Äî —ç–Ω–µ—Ä–≥–∏—è –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è

// –ù–µ —É–ø–æ–º–∏–Ω–∞–π –ª—é–±–æ–≤—å, —Å–µ–∫—Å, –¥–µ–Ω—å–≥–∏, —Ñ–∏–Ω–∞–Ω—Å—ã, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å, –≤–µ–Ω–µ—Ä—É –∏ 12 –¥–æ–º. –ì–æ–≤–æ—Ä–∏ —Ç–µ–ø–ª–æ, –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏, –±–µ–∑ —ç–∑–æ—Ç–µ—Ä–∏–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏, –≥–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.

// –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –≤—ã–≤–æ–¥:
// ‚Äî
// ‚ú® –í –∏—Ç–æ–≥–µ: ... (–≥–ª–∞–≤–Ω—ã–π –∏—Ç–æ–≥ –æ —á–µ–ª–æ–≤–µ–∫–µ)
// `;

//     let sent = false;
//     let lastErr = null;

//     for (const model of MODEL_CHAIN) {
//       try {
//         const { data } = await axios.post(
//           "https://openrouter.ai/api/v1/chat/completions",
//           {
//             model,
//             messages: [
//               {
//                 role: "system",
//                 content:
//                   "–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–º–∞–π–ª–∏–∫–∏, –ø–∏—à–∏ —Å—Ç—Ä–æ–≥–æ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —à–∞–±–ª–æ–Ω–µ.",
//               },
//               { role: "user", content: prompt },
//             ],
//           },
//           {
//             headers: {
//               Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}`,
//               "HTTP-Referer": `https://t.me/${process.env.BOT_USERNAME}`,
//               "Content-Type": "application/json",
//             },
//           }
//         );

//         const out =
//           data.choices?.[0]?.message?.content?.trim() ||
//           "üåå –ó–≤—ë–∑–¥—ã –º–æ–ª—á–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.";

//         await ctx.reply(out);

//         logger.info(
//           `üì§ @${username || id}: ${model} | ${Date.now() - tsStart} –º—Å`
//         );

//         sent = true;
//         break;
//       } catch (e) {
//         lastErr = e;
//         logger.warn(
//           { model, err: e.response?.status || e.message },
//           "‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å"
//         );
//       }
//     }

//     if (!sent) {
//       logger.error(
//         { userId: id, err: lastErr?.response?.data || lastErr?.message },
//         "‚ùå –í—Å–µ –º–æ–¥–µ–ª–∏ —É–ø–∞–ª–∏"
//       );
//       ctx.reply("üõ†Ô∏è –ó–≤—ë–∑–¥—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.");
//     }
//   });

//   // –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç, –Ω–æ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
//   bot.on("text", (ctx, next) => {
//     if (!isValidNatal(ctx.message.text)) {
//       return ctx.reply(
//         "ü§î –§–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π. –ò—Å–ø–æ–ª—å–∑—É–π: –î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú –ì–æ—Ä–æ–¥\n–ù–∞–ø—Ä.: 01.01.2000 10:00 –ú–æ—Å–∫–≤–∞"
//       );
//     }
//     return next();
//   });
// };
